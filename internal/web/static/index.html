<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <title>NFC Agent Status</title>
    <style>
        :root {
            --bg: #0f0f0f;
            --card-bg: #1a1a1a;
            --border: #2a2a2a;
            --text: #e0e0e0;
            --text-muted: #808080;
            --accent: #3b82f6;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 24px;
            line-height: 1.5;
        }

        .container {
            max-width: 640px;
            margin: 0 auto;
        }

        header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 32px;
        }

        .logo {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.online {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .status-badge.offline {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .info-grid {
            display: grid;
            gap: 12px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: var(--text-muted);
            font-size: 14px;
        }

        .info-value {
            font-weight: 500;
            font-size: 14px;
        }

        .reader-list {
            list-style: none;
        }

        .reader-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .reader-item:last-child {
            margin-bottom: 0;
        }

        .reader-icon {
            width: 36px;
            height: 36px;
            background: var(--accent);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .reader-info {
            flex: 1;
            min-width: 0;
        }

        .reader-name {
            font-weight: 500;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .reader-type {
            color: var(--text-muted);
            font-size: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 32px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 32px;
            margin-bottom: 8px;
            opacity: 0.5;
        }

        footer {
            text-align: center;
            margin-top: 32px;
            color: var(--text-muted);
            font-size: 12px;
        }

        footer a {
            color: var(--accent);
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        .refresh-indicator {
            font-size: 11px;
            color: var(--text-muted);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            animation: pulse 1.5s infinite;
        }

        /* Log viewer styles */
        .log-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .log-controls select, .log-controls button {
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .log-controls select:hover, .log-controls button:hover {
            border-color: var(--accent);
        }

        .log-viewer {
            max-height: 300px;
            overflow-y: auto;
            background: var(--bg);
            border-radius: 8px;
            padding: 8px;
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            font-size: 11px;
        }

        .log-entry {
            padding: 4px 8px;
            border-radius: 4px;
            margin-bottom: 4px;
            display: flex;
            gap: 8px;
            align-items: flex-start;
        }

        .log-entry:last-child {
            margin-bottom: 0;
        }

        .log-entry.debug { background: rgba(128, 128, 128, 0.1); }
        .log-entry.info { background: rgba(59, 130, 246, 0.1); }
        .log-entry.warn { background: rgba(245, 158, 11, 0.15); }
        .log-entry.error { background: rgba(239, 68, 68, 0.15); }

        .log-time {
            color: var(--text-muted);
            white-space: nowrap;
            flex-shrink: 0;
        }

        .log-level {
            font-weight: 600;
            width: 50px;
            flex-shrink: 0;
        }

        .log-level.debug { color: var(--text-muted); }
        .log-level.info { color: var(--accent); }
        .log-level.warn { color: var(--warning); }
        .log-level.error { color: var(--error); }

        .log-cat {
            color: var(--text-muted);
            width: 70px;
            flex-shrink: 0;
        }

        .log-msg {
            flex: 1;
            word-break: break-word;
        }

        .log-data {
            color: var(--text-muted);
            font-size: 10px;
            margin-top: 2px;
        }

        .log-empty {
            text-align: center;
            padding: 24px;
            color: var(--text-muted);
        }

        .log-stats {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Test section styles */
        .test-section {
            padding: 4px 0;
        }

        .test-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .test-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            white-space: nowrap;
        }

        .test-btn:hover {
            opacity: 0.9;
        }

        .test-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .test-result {
            font-size: 12px;
            padding: 8px;
            border-radius: 6px;
            display: none;
        }

        .test-result.show {
            display: block;
        }

        .test-result.success {
            background: rgba(34, 197, 94, 0.15);
            color: var(--success);
        }

        .test-result.error {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
        }

        .test-result.info {
            background: rgba(59, 130, 246, 0.1);
            color: var(--text);
        }

        .test-result pre {
            margin: 4px 0 0 0;
            font-size: 11px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* Toggle switch styles */
        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .toggle-label {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .toggle-label-text {
            font-size: 14px;
            font-weight: 500;
        }

        .toggle-label-desc {
            font-size: 12px;
            color: var(--text-muted);
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: 0.2s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.2s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--success);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .toggle-switch input:disabled + .toggle-slider {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Navigation bar */
        .nav-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 24px;
            padding: 12px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
        }

        .nav-item {
            padding: 6px 12px;
            font-size: 13px;
            color: var(--text-muted);
            text-decoration: none;
            border-radius: 6px;
            transition: background 0.15s, color 0.15s;
        }

        .nav-item:hover {
            background: var(--bg);
            color: var(--text);
        }

        .card {
            scroll-margin-top: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo"><img src="/favicon.ico" alt="NFC Agent" width="24" height="24"></div>
            <h1>NFC Agent</h1>
        </header>

        <nav class="nav-bar">
            <a href="#status" class="nav-item">Status</a>
            <a href="#settings" class="nav-item">Settings</a>
            <a href="#readers" class="nav-item">Readers</a>
            <a href="#test" class="nav-item">Test</a>
            <a href="#logs" class="nav-item">Logs</a>
            <a href="#about" class="nav-item">About</a>
        </nav>

        <div class="card" id="status">
            <div class="card-header">
                <span class="card-title">Status</span>
                <span class="status-badge online" id="status-badge">
                    <span class="status-dot"></span>
                    <span id="status-text">Online</span>
                </span>
            </div>
            <div class="info-grid">
                <div class="info-row">
                    <span class="info-label">Version</span>
                    <span class="info-value" id="version">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Build Time</span>
                    <span class="info-value" id="build-time">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Git Commit</span>
                    <span class="info-value" id="git-commit">-</span>
                </div>
            </div>
        </div>

        <div class="card" id="settings">
            <div class="card-header">
                <span class="card-title">Settings</span>
            </div>
            <div class="toggle-row">
                <div class="toggle-label">
                    <span class="toggle-label-text">Start on login</span>
                    <span class="toggle-label-desc" id="autostart-status">Loading...</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="autostart-toggle" onchange="toggleAutostart()" disabled>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="toggle-row" style="border-top: 1px solid var(--border); margin-top: 8px; padding-top: 16px;">
                <div class="toggle-label">
                    <span class="toggle-label-text">Crash reporting</span>
                    <span class="toggle-label-desc" id="crash-reporting-status">Loading...</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="crash-reporting-toggle" onchange="toggleCrashReporting()" disabled>
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>

        <div class="card" id="readers">
            <div class="card-header">
                <span class="card-title">Connected Readers</span>
                <span class="refresh-indicator" id="reader-count">0 readers</span>
            </div>
            <ul class="reader-list" id="reader-list">
                <li class="empty-state">
                    <div class="empty-state-icon">-</div>
                    <div>No readers connected</div>
                </li>
            </ul>
        </div>

        <div class="card" id="test">
            <div class="card-header">
                <span class="card-title">Test Read/Write</span>
                <select id="test-reader" style="background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                    <option value="">No readers</option>
                </select>
            </div>
            <div class="test-section" id="test-section">
                <div id="test-no-readers" class="empty-state" style="padding: 16px;">
                    <div style="color: var(--text-muted);">Connect a reader to test</div>
                </div>
                <div id="test-controls" style="display: none;">
                    <div class="test-row">
                        <button onclick="testRead()" id="btn-read" class="test-btn">Read Card</button>
                        <div id="read-result" class="test-result"></div>
                    </div>
                    <div class="test-row" style="margin-top: 12px;">
                        <div style="display: flex; gap: 8px; flex-wrap: wrap; align-items: center;">
                            <select id="write-type" style="background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 6px 8px; border-radius: 4px; font-size: 12px;">
                                <option value="text">Text</option>
                                <option value="url">URL</option>
                                <option value="json">JSON</option>
                            </select>
                            <input type="text" id="write-data" placeholder="Data to write..." style="flex: 1; min-width: 150px; background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 6px 8px; border-radius: 4px; font-size: 12px;">
                            <button onclick="testWrite()" id="btn-write" class="test-btn">Write</button>
                        </div>
                        <div id="write-result" class="test-result"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card" id="logs">
            <div class="card-header">
                <span class="card-title">Logs</span>
                <div class="log-controls">
                    <select id="log-level">
                        <option value="">All Levels</option>
                        <option value="debug">Debug</option>
                        <option value="info">Info</option>
                        <option value="warn">Warn</option>
                        <option value="error">Error</option>
                    </select>
                    <select id="log-category">
                        <option value="">All Categories</option>
                        <option value="http">HTTP</option>
                        <option value="websocket">WebSocket</option>
                        <option value="reader">Reader</option>
                        <option value="card">Card</option>
                        <option value="system">System</option>
                    </select>
                    <button onclick="clearLogs()">Clear</button>
                    <button onclick="downloadLogs()">Download</button>
                    <span class="log-stats" id="log-stats"></span>
                </div>
            </div>
            <div class="log-viewer" id="log-viewer">
                <div class="log-empty">No logs yet</div>
            </div>
        </div>

        <div class="card" id="crash-logs-card" style="display: none;">
            <div class="card-header">
                <span class="card-title">Crash Reports</span>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span class="refresh-indicator" id="crash-count">0 reports</span>
                    <button onclick="reportIssueOnGitHub()" class="test-btn" style="padding: 4px 12px; font-size: 12px; background: #238636;">Report issue on GitHub</button>
                </div>
            </div>
            <div id="crash-logs-content">
                <div class="log-empty">No crash reports</div>
            </div>
        </div>

        <div class="card" id="about">
            <div class="card-header">
                <span class="card-title">About NFC Agent</span>
            </div>
            <div style="font-size: 14px; line-height: 1.6;">
                <p style="margin-bottom: 12px;">
                    NFC Agent is an <strong>API service</strong> that enables applications to interact with NFC readers. It doesn't do anything on its own — it's the bridge that lets software communicate with your NFC hardware.
                </p>
                <p style="margin-bottom: 12px; padding: 12px; background: var(--bg); border-radius: 8px;">
                    <strong>SimplyPrint users:</strong> Just install and keep it running! <a href="https://simplyprint.io" target="_blank" style="color: var(--accent);">SimplyPrint</a> will automatically use it to read and write filament NFC tags from your browser—no additional setup required.
                </p>
                <p style="margin-bottom: 12px; color: var(--text-muted); font-size: 13px;">
                    Developers can use the HTTP/WebSocket API from any programming language.
                    <a href="https://github.com/SimplyPrint/nfc-agent" target="_blank" style="color: var(--accent);">View source and documentation</a>
                </p>
                <p style="margin-bottom: 0; padding: 10px 12px; background: rgba(245, 158, 11, 0.1); border-radius: 8px; font-size: 13px; color: var(--warning);">
                    <strong>Note:</strong> If your NFC reader emulates a keyboard (types tag data automatically), you don't need NFC Agent — those readers work directly with any text field.
                </p>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span class="card-title">Supported Hardware</span>
                <span class="refresh-indicator" id="supported-reader-count"></span>
            </div>
            <div id="supported-readers-content" style="font-size: 13px;">
                <div class="empty-state" style="padding: 16px;">Loading...</div>
            </div>
        </div>

        <footer>
            <p>NFC Agent by <a href="https://simplyprint.io" target="_blank">SimplyPrint</a></p>
            <p style="margin-top: 4px;">Auto-refreshes every 5 seconds</p>
            <button onclick="shutdownAgent()" style="margin-top: 12px; background: var(--error); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px;">Exit Agent</button>
        </footer>
    </div>

    <script>
        async function fetchData() {
            try {
                // Fetch version info
                const versionRes = await fetch('/v1/version');
                const version = await versionRes.json();

                document.getElementById('version').textContent = version.version || '-';
                document.getElementById('build-time').textContent = formatDate(version.buildTime) || '-';
                document.getElementById('git-commit').textContent = version.gitCommit ? version.gitCommit.substring(0, 7) : '-';

                // Fetch readers
                const readersRes = await fetch('/v1/readers');
                const readers = await readersRes.json();

                updateReaderList(readers);

                // Update status
                setOnline(true);
            } catch (error) {
                console.error('Failed to fetch data:', error);
                setOnline(false);
            }
        }

        function setOnline(online) {
            const badge = document.getElementById('status-badge');
            const text = document.getElementById('status-text');

            if (online) {
                badge.className = 'status-badge online';
                text.textContent = 'Online';
            } else {
                badge.className = 'status-badge offline';
                text.textContent = 'Offline';
            }
        }

        function updateReaderList(readers) {
            const list = document.getElementById('reader-list');
            const count = document.getElementById('reader-count');

            count.textContent = readers.length === 1 ? '1 reader' : `${readers.length} readers`;

            // Update test dropdown
            updateTestReaderDropdown(readers);

            if (readers.length === 0) {
                list.innerHTML = `
                    <li class="empty-state">
                        <div class="empty-state-icon">-</div>
                        <div>No readers connected</div>
                    </li>
                `;
                return;
            }

            list.innerHTML = readers.map((reader, index) => `
                <li class="reader-item">
                    <div class="reader-icon">${index + 1}</div>
                    <div class="reader-info">
                        <div class="reader-name" title="${escapeHtml(reader.name)}">${escapeHtml(reader.name)}</div>
                        <div class="reader-type">Type: ${escapeHtml(reader.type || 'Unknown')}</div>
                    </div>
                </li>
            `).join('');
        }

        function formatDate(dateStr) {
            if (!dateStr || dateStr === 'unknown') return 'Unknown';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
            } catch {
                return dateStr;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Log functions
        async function fetchLogs() {
            try {
                const level = document.getElementById('log-level').value;
                const category = document.getElementById('log-category').value;

                let url = '/v1/logs?limit=100';
                if (level) url += `&level=${level}`;
                if (category) url += `&category=${category}`;

                const res = await fetch(url);
                const data = await res.json();

                updateLogViewer(data.entries, data.stats);
            } catch (error) {
                console.error('Failed to fetch logs:', error);
            }
        }

        function updateLogViewer(entries, stats) {
            const viewer = document.getElementById('log-viewer');
            const statsEl = document.getElementById('log-stats');

            if (stats) {
                statsEl.textContent = `${stats.total_entries}/${stats.max_entries}`;
            }

            if (!entries || entries.length === 0) {
                viewer.innerHTML = '<div class="log-empty">No logs yet</div>';
                return;
            }

            viewer.innerHTML = entries.map(entry => {
                const time = new Date(entry.timestamp).toLocaleTimeString();
                const level = entry.level.toLowerCase();
                const dataStr = entry.data ? JSON.stringify(entry.data) : '';

                return `
                    <div class="log-entry ${level}">
                        <span class="log-time">${time}</span>
                        <span class="log-level ${level}">${entry.level}</span>
                        <span class="log-cat">${escapeHtml(entry.category)}</span>
                        <div class="log-msg">
                            ${escapeHtml(entry.message)}
                            ${dataStr ? `<div class="log-data">${escapeHtml(dataStr)}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function clearLogs() {
            try {
                await fetch('/v1/logs', { method: 'DELETE' });
                fetchLogs();
            } catch (error) {
                console.error('Failed to clear logs:', error);
            }
        }

        async function downloadLogs() {
            try {
                // Fetch all logs (up to max)
                const logsRes = await fetch('/v1/logs?limit=1000');
                const logsData = await logsRes.json();

                // Fetch version info for context
                const versionRes = await fetch('/v1/version');
                const versionData = await versionRes.json();

                // Fetch reader info
                const readersRes = await fetch('/v1/readers');
                const readersData = await readersRes.json();

                // Build export object
                const exportData = {
                    exportedAt: new Date().toISOString(),
                    agent: versionData,
                    readers: readersData,
                    logs: logsData
                };

                // Create and download file
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `nfc-agent-logs-${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Failed to download logs:', error);
                alert('Failed to download logs');
            }
        }

        async function shutdownAgent() {
            if (!confirm('Are you sure you want to exit the NFC Agent?')) {
                return;
            }
            try {
                await fetch('/v1/shutdown', { method: 'POST' });
                document.body.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100vh; color: var(--text-muted);">NFC Agent has been stopped.</div>';
            } catch (error) {
                console.error('Failed to shutdown:', error);
            }
        }

        // Test functions
        let cachedReaders = [];

        function updateTestReaderDropdown(readers) {
            cachedReaders = readers;
            const select = document.getElementById('test-reader');
            const noReaders = document.getElementById('test-no-readers');
            const controls = document.getElementById('test-controls');

            if (readers.length === 0) {
                select.innerHTML = '<option value="">No readers</option>';
                select.style.display = 'none';
                noReaders.style.display = 'block';
                controls.style.display = 'none';
            } else {
                select.innerHTML = readers.map((r, i) =>
                    `<option value="${i}">${escapeHtml(r.name)}</option>`
                ).join('');
                select.style.display = 'block';
                noReaders.style.display = 'none';
                controls.style.display = 'block';
            }
        }

        function showResult(elementId, type, message) {
            const el = document.getElementById(elementId);
            el.className = `test-result show ${type}`;
            el.innerHTML = message;
        }

        async function testRead() {
            const select = document.getElementById('test-reader');
            const readerIndex = select.value;

            if (readerIndex === '' || cachedReaders.length === 0) {
                showResult('read-result', 'error', 'No reader selected');
                return;
            }

            showResult('read-result', 'info', 'Reading...');

            try {
                const res = await fetch(`/v1/readers/${readerIndex}/card`);
                const data = await res.json();

                if (!res.ok) {
                    showResult('read-result', 'error', data.error || 'Read failed');
                    return;
                }

                let html = `<strong>UID:</strong> ${escapeHtml(data.uid)}<br>`;
                html += `<strong>Type:</strong> ${escapeHtml(data.type || 'Unknown')}`;
                if (data.data) {
                    html += `<br><strong>Data:</strong> <pre>${escapeHtml(data.data)}</pre>`;
                }
                if (data.url) {
                    html += `<br><strong>URL:</strong> ${escapeHtml(data.url)}`;
                }
                showResult('read-result', 'success', html);
            } catch (error) {
                showResult('read-result', 'error', 'Failed to read card');
            }
        }

        async function testWrite() {
            const select = document.getElementById('test-reader');
            const readerIndex = select.value;
            const dataType = document.getElementById('write-type').value;
            const data = document.getElementById('write-data').value;

            if (readerIndex === '' || cachedReaders.length === 0) {
                showResult('write-result', 'error', 'No reader selected');
                return;
            }

            if (!data.trim()) {
                showResult('write-result', 'error', 'Please enter data to write');
                return;
            }

            showResult('write-result', 'info', 'Writing...');

            try {
                const res = await fetch(`/v1/readers/${readerIndex}/card`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data, dataType })
                });
                const result = await res.json();

                if (!res.ok) {
                    showResult('write-result', 'error', result.error || 'Write failed');
                    return;
                }

                showResult('write-result', 'success', 'Written successfully!');
                document.getElementById('write-data').value = '';
            } catch (error) {
                showResult('write-result', 'error', 'Failed to write to card');
            }
        }

        // Auto-start functions
        async function fetchAutostartStatus() {
            try {
                const res = await fetch('/v1/autostart');
                const data = await res.json();

                const toggle = document.getElementById('autostart-toggle');
                const status = document.getElementById('autostart-status');

                toggle.checked = data.enabled;
                toggle.disabled = false;

                if (data.enabled) {
                    status.textContent = 'NFC Agent will start automatically when you log in';
                } else {
                    status.textContent = 'NFC Agent will not start automatically';
                }
            } catch (error) {
                console.error('Failed to fetch autostart status:', error);
                document.getElementById('autostart-status').textContent = 'Unable to check status';
            }
        }

        async function toggleAutostart() {
            const toggle = document.getElementById('autostart-toggle');
            const status = document.getElementById('autostart-status');
            const enabled = toggle.checked;

            toggle.disabled = true;
            status.textContent = enabled ? 'Enabling...' : 'Disabling...';

            try {
                const res = await fetch('/v1/autostart', {
                    method: enabled ? 'POST' : 'DELETE'
                });
                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Failed to update autostart');
                }

                if (enabled) {
                    status.textContent = 'NFC Agent will start automatically when you log in';
                } else {
                    status.textContent = 'NFC Agent will not start automatically';
                }
            } catch (error) {
                console.error('Failed to toggle autostart:', error);
                status.textContent = 'Error: ' + error.message;
                // Revert toggle state
                toggle.checked = !enabled;
            } finally {
                toggle.disabled = false;
            }
        }

        // Crash reporting functions
        async function fetchCrashReportingStatus() {
            try {
                const res = await fetch('/v1/settings');
                const data = await res.json();

                const toggle = document.getElementById('crash-reporting-toggle');
                const status = document.getElementById('crash-reporting-status');

                toggle.checked = data.crashReporting;
                toggle.disabled = false;
                status.style.color = '';

                if (data.crashReporting) {
                    status.textContent = 'Enabled — sent via Sentry to help fix bugs';
                } else {
                    status.textContent = 'Disabled — crash reports stay local only';
                }
            } catch (error) {
                console.error('Failed to fetch crash reporting status:', error);
                document.getElementById('crash-reporting-status').textContent = 'Unable to check status';
            }
        }

        async function toggleCrashReporting() {
            const toggle = document.getElementById('crash-reporting-toggle');
            const status = document.getElementById('crash-reporting-status');
            const enabled = toggle.checked;

            toggle.disabled = true;
            status.textContent = enabled ? 'Enabling...' : 'Disabling...';

            try {
                const res = await fetch('/v1/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ crashReporting: enabled })
                });
                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Failed to update setting');
                }

                if (data.crashReporting) {
                    status.textContent = 'Enabled — restart NFC Agent for changes to take effect';
                    status.style.color = 'var(--warning)';
                } else {
                    status.textContent = 'Disabled — restart NFC Agent for changes to take effect';
                    status.style.color = 'var(--warning)';
                }
            } catch (error) {
                console.error('Failed to toggle crash reporting:', error);
                status.textContent = 'Error: ' + error.message;
                status.style.color = '';
                // Revert toggle state
                toggle.checked = !enabled;
            } finally {
                toggle.disabled = false;
            }
        }

        // Crash logs functions
        async function fetchCrashLogs() {
            try {
                const res = await fetch('/v1/crashes?limit=10');
                const data = await res.json();

                const card = document.getElementById('crash-logs-card');
                const content = document.getElementById('crash-logs-content');
                const count = document.getElementById('crash-count');

                if (!data.crashes || data.crashes.length === 0) {
                    card.style.display = 'none';
                    return;
                }

                card.style.display = 'block';
                count.textContent = data.crashes.length === 1 ? '1 report' : `${data.crashes.length} reports`;

                content.innerHTML = `
                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px;">
                        Stored locally in: ${escapeHtml(data.crashDir)}
                    </div>
                    <div class="crash-list">
                        ${data.crashes.map(crash => `
                            <div class="reader-item" style="flex-direction: column; align-items: flex-start; gap: 8px;">
                                <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                                    <div>
                                        <div style="font-weight: 500; font-size: 13px;">${escapeHtml(crash.name)}</div>
                                        <div style="font-size: 12px; color: var(--text-muted);">${formatDate(crash.modTime)} &middot; ${formatSize(crash.size)}</div>
                                    </div>
                                    <button onclick="downloadCrashLog('${escapeHtml(crash.name)}')" class="test-btn" style="padding: 4px 12px; font-size: 12px;">Download</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Failed to fetch crash logs:', error);
            }
        }

        async function downloadCrashLog(filename) {
            try {
                const res = await fetch(`/v1/crashes?file=${encodeURIComponent(filename)}`);
                const data = await res.json();

                if (!res.ok) {
                    alert(data.error || 'Failed to download crash log');
                    return;
                }

                const blob = new Blob([data.content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Failed to download crash log:', error);
                alert('Failed to download crash log');
            }
        }

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        async function reportIssueOnGitHub() {
            // Gather system info
            let version = document.getElementById('version').textContent || 'unknown';
            let gitCommit = document.getElementById('git-commit').textContent || 'unknown';

            const title = 'Crash report: [Brief description of what happened]';
            const body = `## Description
<!-- Describe what you were doing when the crash occurred -->


## Environment
- **NFC Agent Version:** ${version}
- **Git Commit:** ${gitCommit}
- **OS:** ${navigator.platform}
- **Browser (if applicable):** ${navigator.userAgent.split(' ').slice(-2).join(' ')}

## Steps to Reproduce
<!-- If you can reproduce the crash, list the steps here -->
1.
2.
3.

## Crash Report
<!--
IMPORTANT: Please attach the crash report file(s) to this issue!

1. Click the "Download" button next to each crash report in the NFC Agent status page
2. Drag and drop the downloaded .log file(s) into this text area

The crash report contains technical details that help us fix the bug.
-->

## Additional Context
<!-- Add any other relevant information, screenshots, or logs here -->

`;

            const url = `https://github.com/SimplyPrint/nfc-agent/issues/new?title=${encodeURIComponent(title)}&body=${encodeURIComponent(body)}`;
            window.open(url, '_blank');
        }

        // Supported readers functions
        const readerBuyLinks = {
            'ACR122U': 'https://amzn.to/48NzOkF',
            'ACR1252U': 'https://amzn.to/48Ne1tb',
            'ACR1255U-J1': 'https://amzn.to/3KNB1Aj',
            'ACR1552U': 'https://amzn.to/48KvK4v'
        };

        async function fetchSupportedReaders() {
            try {
                const res = await fetch('/v1/supported-readers');
                const data = await res.json();

                const content = document.getElementById('supported-readers-content');
                const count = document.getElementById('supported-reader-count');

                if (!data.readers || data.readers.length === 0) {
                    content.innerHTML = '<div class="empty-state" style="padding: 16px;">No supported readers data available</div>';
                    return;
                }

                // Group by manufacturer
                const byManufacturer = {};
                data.readers.forEach(r => {
                    if (!byManufacturer[r.manufacturer]) {
                        byManufacturer[r.manufacturer] = [];
                    }
                    byManufacturer[r.manufacturer].push(r);
                });

                count.textContent = `${data.readers.length} models`;

                let html = '<div style="color: var(--text-muted); margin-bottom: 12px;">Any <strong style="color: var(--text);">PC/SC compatible</strong> USB NFC reader will work. Tested models:</div>';

                // Recommendation
                html += '<div style="background: rgba(34, 197, 94, 0.1); border-radius: 8px; padding: 10px 12px; margin-bottom: 12px;">';
                html += '<div style="font-weight: 500; color: var(--success); margin-bottom: 4px;">Recommended: ACR1552U</div>';
                html += '<div style="font-size: 12px; color: var(--text-muted);">Supports the widest range of tags including NTAG 424 DNA, required for <a href="https://openprinttag.org" target="_blank" style="color: var(--accent);">OpenPrintTag</a> filament tags. ';
                html += '<a href="https://amzn.to/48KvK4v" target="_blank" style="color: var(--accent);">Buy on Amazon</a></div>';
                html += '</div>';

                html += '<div style="display: flex; flex-direction: column; gap: 8px;">';

                for (const [manufacturer, readers] of Object.entries(byManufacturer)) {
                    html += `<div style="background: var(--bg); border-radius: 8px; padding: 10px 12px;">`;
                    html += `<div style="font-weight: 500; margin-bottom: 4px;">${escapeHtml(manufacturer)}</div>`;
                    html += `<div style="color: var(--text-muted); font-size: 12px;">${readers.map(r => {
                        const link = readerBuyLinks[r.name];
                        if (link) {
                            return `<a href="${link}" target="_blank" style="color: var(--accent);">${escapeHtml(r.name)}</a>`;
                        }
                        return escapeHtml(r.name);
                    }).join(', ')}</div>`;
                    html += `</div>`;
                }

                html += '</div>';
                html += '<div style="font-size: 11px; color: var(--text-muted); margin-top: 12px; opacity: 0.7;">Amazon links are affiliate links.</div>';
                content.innerHTML = html;
            } catch (error) {
                console.error('Failed to fetch supported readers:', error);
                document.getElementById('supported-readers-content').innerHTML = '<div class="empty-state" style="padding: 16px;">Failed to load</div>';
            }
        }

        // Add event listeners for filter changes
        document.getElementById('log-level').addEventListener('change', fetchLogs);
        document.getElementById('log-category').addEventListener('change', fetchLogs);

        // Initial fetch
        fetchData();
        fetchLogs();
        fetchAutostartStatus();
        fetchCrashReportingStatus();
        fetchCrashLogs();
        fetchSupportedReaders();

        // Refresh every 5 seconds
        setInterval(fetchData, 5000);
        setInterval(fetchLogs, 2000);
    </script>
</body>
</html>
